-- register createFromTemplate field function for terminbrief
INSERT  INTO `os_functions` (`iconname`,`functionmachine`,`functionreadable`,`functionscope`,`allowed_roles`,`functionconfig`,`functionflags`) SELECT 'template','createFromTemplate','ODF erzeugen','FIELD','[0]','{"terminbrief":{"default":{"namereadable":"Terminbrief erstellen","description":"erstellt einen Terminbrief aus der Vorlage","src":"Terminbriefvorlage.odt","filename":"$opsz_aufnahme__name - $opsz_aufnahme__vorname.odt","vars":{"NAME":"$opsz_aufnahme__name","VORNAME":"$opsz_aufnahme__vorname","ADRESSE":"$opsz_aufnahme__adresse","DATUM":"$ENV(date)","ANREDE":"%%if ( $opsz_aufnahme__geschlecht == 'weiblich' ) { 'Liebe Frau' } %%else { 'Lieber Herr'} %%endif","TYP_WEIBLICH":"%%if ( $opsz_vermittlungslisten__vermitteltzu[1][last] == 'PsychiaterInnen' ) { 'Psychiaterin' } %%endif %%if ( $opsz_vermittlungslisten__vermitteltzu[1][last] == 'TherapeutInnen' ) { 'Therapeutin' } %%endif","TYP_MÃ„NNLICH":"%%if ( $opsz_vermittlungslisten__vermitteltzu[1][last] == 'PsychiaterInnen' ) { 'Psychiater' } %%endif %%if ( $opsz_vermittlungslisten__vermitteltzu[1][last] == 'TherapeutInnen' ) { 'Therapeut' } %%endif","TERMINDATUM":"$opsz_vermittlungslisten__vermitteltzu[4][last]","PTNAME":"$opsz_vermittlungslisten__vermitteltzu[2][last]","PTADRESSE":"$opsz_vermittlungslisten__vermitteltzu[3][last]"}}}}','[{"ONTABLES":{"terminbrief":["opsz_vermittlungslisten"]}}]' FROM DUAL WHERE  (SELECT count(functionmachine) FROM `os_functions` where functionmachine = 'createFromTemplate') = 0;
-- create function field for createFromTemplate(terminbrief) in vermittlungslisten
ALTER TABLE `opsz_vermittlungslisten` ADD COLUMN IF NOT EXISTS `erstelleBrief` TEXT DEFAULT NULL;
INSERT  INTO `opsz_vermittlungslisten_permissions` (`keymachine`,`keyreadable`,`realid`,`typelist`,`edittype`,`referencetag`,`role_0`) SELECT 'erstelleBrief','erstelle Terminbrief','11.5','TEXT','FUNCTION','_erstelleBrief','0' FROM DUAL WHERE (SELECT count(*) FROM information_schema.COLUMNS WHERE TABLE_NAME = 'opsz_vermittlungslisten' AND COLUMN_NAME = 'erstelleBrief') > 0 AND (SELECT count(keymachine) FROM `opsz_vermittlungslisten_permissions` where keymachine = 'erstelleBrief') = 0;
INSERT  INTO `opsz_vermittlungslisten_references` (`referencetag`,`allowed_values`) VALUES ('_erstelleBrief','["_SHOW_","createFromTemplate(terminbrief)"]');
