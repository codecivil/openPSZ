-- change trafficLight config
UPDATE `os_functions`SET `iconname`= 'traffic-light',`functionmachine`= 'trafficLight',`functionreadable`= 'Ampel',`functionscope`= 'TABLES',`functiontarget`= 'important',`functionconfig`= '{"criteria":[{"name":"zu lange auf Liste Stellungnahme","sql":"SELECT DATEDIFF(CURRENT_DATE(),stellungnahmeseit) from opsz_aufnahme WHERE DATEDIFF(CURRENT_DATE(),stellungnahmeseit) > 41","relation":">","benchmark":"41","urgency":1,"table":"opsz_aufnahme","associated_table":"opsz_aufnahme","display":"Tage"},{"name":"zu lange auf Liste Stellungnahme","sql":"SELECT DATEDIFF(CURRENT_DATE(),stellungnahmeseit) from opsz_aufnahme WHERE DATEDIFF(CURRENT_DATE(),stellungnahmeseit) > 89","relation":">","benchmark":"89","urgency":3,"associated_table":"opsz_aufnahme","table":"opsz_aufnahme"},{"name":"zu lange auf Vermittlungslisten","sql":"SELECT DATEDIFF(CURRENT_DATE(),auflisteseit) from opsz_vermittlungslisten WHERE DATEDIFF(CURRENT_DATE(),auflisteseit) > 41","relation":">","benchmark":"41","urgency":1,"associated_table":"opsz_vermittlungslisten","table":"opsz_aufnahme","display":"Tage"},{"name":"zu lange auf Vermittlungslisten","sql":"SELECT DATEDIFF(CURRENT_DATE(),auflisteseit) from opsz_vermittlungslisten WHERE DATEDIFF(CURRENT_DATE(),auflisteseit) > 89","relation":">","benchmark":"89","urgency":3,"associated_table":"opsz_vermittlungslisten","table":"opsz_aufnahme"},{"name":"zu viele Termine in 6 Monaten und nur OS","notimplies":[{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH)","relation":">=","benchmark":"5","display":""},{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH) AND typ != 'OS'","relation":">","benchmark":"0"}],"urgency":1,"associated_table":"opsz_termine","table":"opsz_aufnahme"},{"name":"zu viele Termine in 6 Monaten und nur OS","notimplies":[{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH)","relation":">=","benchmark":"10"},{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH) AND typ != 'OS'","relation":">","benchmark":"0"}],"urgency":2,"associated_table":"opsz_termine","table":"opsz_aufnahme"},{"name":"zu viele Termine in 6 Monaten und nur OS","notimplies":[{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH)","relation":">=","benchmark":"20"},{"sql":"SELECT count(id_opsz_aufnahme) from opsz_termine WHERE beginn < CURRENT_DATE() AND beginn >= DATE_ADD(CURRENT_DATE(), INTERVAL -6 MONTH) AND typ != 'OS'","relation":">","benchmark":"0"}],"urgency":3,"associated_table":"opsz_termine","table":"opsz_aufnahme"},{"name":"Erinnerung an BaDo","and":[{"sql":"SELECT count(id_opsz_aufnahme) FROM opsz_termine WHERE typ != '*Sonstiges' AND typ != 'Vermittlung'","relation":">=","benchmark":"2"},{"sql":"SELECT standderakte FROM opsz_refukey","relation":"!=","benchmark":"geschlossen"},{"sql":"SELECT badoiiausgefuellt FROM opsz_refukey","relation":"!=","benchmark":"ja"},{"or":[{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":"*keine"},{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":""}]}],"urgency":1,"associated_table":"opsz_refukey","table":"opsz_aufnahme"},{"name":"Erinnerung an refuKey I","and":[{"or":[{"sql":"SELECT aufnahmepsz from opsz_aufnahme","relation":"=","benchmark":"ja"},{"sql":"SELECT standderakte from opsz_refukey","relation":"=","benchmark":"OS"},{"sql":"SELECT standderakte from opsz_refukey","relation":"=","benchmark":"Neuaufnahme"},{"sql":"SELECT standderakte from opsz_refukey","relation":"=","benchmark":"aufgenommen"}]},{"sql":"SELECT refukeyiausgefuellt from opsz_refukey","relation":"!=","benchmark":"ja"},{"or":[{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":"*keine"},{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":""}]},{"sql":"SELECT aktiv from opsz_aufnahme","relation":"!=","benchmark":"nein"}],"urgency":1,"associated_table":"opsz_refukey","table":"opsz_aufnahme"},{"name":"Erinnerung an refuKey II","and":[{"sql":"SELECT count(opsz_termine.id_opsz_aufnahme) from opsz_termine inner join opsz_refukey using (id_opsz_aufnahme) WHERE beginn > refkeyiausgefuelltam","relation":">=","benchmark":"10"},{"sql":"SELECT refukeyiiausgefuelltzehn from opsz_refukey","relation":"!=","benchmark":"ja"},{"or":[{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":"*keine"},{"sql":"SELECT dropout FROM opsz_refukey","relation":"=","benchmark":""}]},{"sql":"SELECT aktiv from opsz_aufnahme","relation":"!=","benchmark":"nein"}],"urgency":1,"associated_table":"opsz_refukey","table":"opsz_aufnahme"}],"identifiers":{"opsz_aufnahme":["name","vorname"]}}' WHERE `functionmachine`= 'trafficLight';

-- correction for "krankenhausaufenthalt": field too short for "*zu kl√§ren" (makes import impossible if that is the exported value)
alter table opsz_aufnahme modify column krankenhausaufenthalt VARCHAR(10);
update opsz_aufnahme_permissions set typelist="VARCHAR(10)" where keymachine = "krankenhausaufenthalt";
